<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.machine.service.data.shop.dao.mapper.DataShopMapper">

    <select id="getIdByCode" resultType="java.lang.String">
        select s.id
        from t_data_shop s
        WHERE s.code = #{code}
    </select>

    <select id="countNotBindOrganization" resultType="java.lang.Integer">
        select count(0)
        from t_data_shop s
        WHERE s.id NOT IN
              (SELECT sor.shop_id
               FROM t_data_shop_organization_relation sor
               WHERE sor.organization_type = #{inputDto.organizationType})
    </select>

    <select id="listNotBindOrganization" resultType="java.lang.String">
        select s.id
        from t_data_shop s
        WHERE s.id NOT IN
              (SELECT sor.shop_id
               FROM t_data_shop_organization_relation sor
               WHERE sor.organization_type = #{inputDto.organizationType})
    </select>

    <select id="listAreaCodeByShopIdSet" resultType="java.lang.String">
        select s.area_code
        from t_data_shop s
        WHERE s.id IN
        <foreach item="item" collection="shopIdSet" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY s.area_code
    </select>

    <select id="listShopIdByShopCodeSet" resultType="java.lang.String">
        select s.id
        from t_data_shop s
        WHERE s.code IN
        <foreach item="item" collection="shopCodeSet" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>


    <select id="listShopIdByAreaCodeSet" resultType="java.lang.String">
        select s.id
        from t_data_shop s
        WHERE s.area_code IN
        <foreach item="item" collection="areaCodeSet" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="selectSimpleByCodeSet" resultType="com.machine.sdk.common.model.response.IdCodeResponse">
        select s.id,s.code
        from t_data_shop s
        where s.code in
        <foreach item="item" collection="codeSet" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <select id="listByOffset" resultType="com.machine.service.data.shop.dao.mapper.entity.DataShopEntity">
        select s.*
        from t_data_shop s
        <where>
            <if test="inputDto.offset != null and inputDto.offset !='' ">
                AND s.id > #{inputDto.offset}
            </if>
        </where>
        ORDER BY s.id ASC
        LIMIT #{inputDto.size}
    </select>

    <select id="listAll" resultType="com.machine.client.data.shop.dto.output.DataShopListSimpleOutputDto">
        select s.*
        from t_data_shop s
        <where>
            <if test="inputDto.businessStatus != null  ">
                AND s.business_status = #{inputDto.businessStatus}
            </if>
            <if test="inputDto.operationStatus != null  ">
                AND s.operation_status = #{inputDto.operationStatus}
            </if>
            <if test="inputDto.physicalStatus != null  ">
                AND s.physical_status = #{inputDto.physicalStatus}
            </if>
        </where>
    </select>

    <select id="selectPage" resultType="com.machine.service.data.shop.dao.mapper.entity.DataShopEntity">
        SELECT s.* FROM t_data_shop s
        <where>
            <if test="inputDto.shopIdSet != null  and inputDto.shopIdSet.size > 0">
                AND s.id IN
                <foreach item="item" collection="inputDto.shopIdSet" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="inputDto.keyword != null and inputDto.keyword !='' ">
                AND (s.name like CONCAT('%', #{inputDto.keyword}, '%') OR
                LOWER(s.code) like LOWER(CONCAT('%', #{inputDto.keyword}, '%')))
            </if>
            <if test="inputDto.code != null and inputDto.code !='' ">
                AND LOWER(s.code) like LOWER(CONCAT('%', #{inputDto.code}, '%'))
            </if>
            <if test="inputDto.name != null and inputDto.name !='' ">
                AND s.name like CONCAT('%', #{inputDto.name}, '%')
            </if>
            <if test="inputDto.businessStatusSet != null and inputDto.businessStatusSet.size > 0">
                AND s.business_status IN
                <foreach item="item" collection="inputDto.businessStatusSet" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="inputDto.operationStatusSet != null and inputDto.operationStatusSet.size > 0">
                AND s.operation_status IN
                <foreach item="item" collection="inputDto.operationStatusSet" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="inputDto.physicalStatusSet != null and inputDto.physicalStatusSet.size > 0">
                AND s.physical_status IN
                <foreach item="item" collection="inputDto.physicalStatusSet" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="inputDto.areaCodeSet != null  and inputDto.areaCodeSet.size > 0">
                AND s.area_code IN
                <foreach item="item" collection="inputDto.areaCodeSet" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
            <if test="inputDto.createStartTime != null ">
                AND s.update_time > #{inputDto.createStartTime}
            </if>
            <if test="inputDto.createEndTime != null ">
                AND s.update_time <![CDATA[ < ]]>  #{inputDto.createEndTime}
            </if>
            <if test="inputDto.updateStartTime != null ">
                AND s.update_time > #{inputDto.updateStartTime}
            </if>
            <if test="inputDto.updateEndTime != null ">
                AND s.update_time <![CDATA[ < ]]>  #{inputDto.updateEndTime}
            </if>
        </where>
        ORDER BY s.create_time DESC
    </select>

    <select id="pageCollectShop" resultType="com.machine.service.data.shop.dao.mapper.entity.DataShopEntity">
        SELECT s.* FROM t_data_shop s
        LEFT JOIN t_user_collect_shop ucs ON ucs.shop_id = s.id
        <where>
            ucs.user_id = #{inputDto.userId}
            <if test="inputDto.keyword != null and inputDto.keyword !='' ">
                AND (s.name like CONCAT('%', #{inputDto.keyword}, '%') OR
                s.code like CONCAT('%', #{inputDto.keyword}, '%'))
            </if>
            <if test="inputDto.shopIdSet != null  and inputDto.shopIdSet.size > 0">
                AND s.id IN
                <foreach item="item" collection="inputDto.shopIdSet" open="(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
        ORDER BY s.create_time DESC
    </select>

</mapper>